/**
 * kifuParser.js v0.0.1
 *
 * Copyright (c) 2015 sandai <sandai310@gmail.com>
 * Released under the MIT license
 */

var kifuParser=function(e){function t(i){if(r[i])return r[i].exports;var n=r[i]={exports:{},id:i,loaded:!1};return e[i].call(n.exports,n,n.exports,t),n.loaded=!0,n.exports}var r={};return t.m=e,t.c=r,t.p="",t(0)}([function(e,t,r){"use strict";function i(e,t){var r="";if(null===e||"string"!=typeof e)throw new Error("KifuParser(source <-I need it yesterday!, format)");if(r=n(a.toLines(e),t),"noformat"===r)throw new Error("This is not a kifu.");return new f[r](e,r)}function n(e,t){for(var r="noformat",i=0,n=e.length,o="";n>i;i++){switch(o=a.trim(e[i]).charAt(0)){case"1":r=s.format("Kif");break;case"▲":case"△":case"▼":case"▽":r=s.format("Ki2");break;case"+":case"-":if(/\d/.test(a.trim(e[i]).charAt(1))){r=s.format("Csa");break}continue;default:continue}break}return r===s.format(t)?s.format(t):r}function o(e,t,r){var n=i(e,t),o=new c(n.parse());return o.build(),r!==!0?o.getKifuObject():o.getKifuJSON()}var a=r(1),s=r(2),c=r(3),u=r(4),p=r(5),h=r(6),f={Kif:u,Ki2:p,Csa:h};e.exports=o},function(e){"use strict";function t(e,t){function r(){}r.prototype=t.prototype,e.prototype=new r,e.prototype.constructor=e}function r(e){for(var t=[],r=e.split(/\r?(?:\n|\r)/),i=0,n=r.length;n>i;i++)""!==r[i]&&t.push(r[i]);return t}function i(e){var t=new RegExp("^(?:[0-9]{4})\\/(?:(0?2)\\/([12][0-9]|0?[1-9])|(0?[469]|11)\\/(30|[12][0-9]|0?[1-9])|(0?[13578]|1[02])\\/(3[01]|[12][0-9]|0?[1-9]))(?:$|[\\s　]+(?:2[0-3]|[01][0-9]):(?:[0-5][0-9])(?:$|:(?:[0-5][0-9])$))");return t.test(e)}function n(e){var t;for(t in e)if("undefined"!=typeof t)return!1;return!0}var o=function(){return String.prototype.trim?function(e){return String.prototype.trim.call(e)}:function(e){return e.replace(/^[\s　]+|[\s　]+$/g,"")}}(),a=function(){function e(e){return r.lastIndex=0,r.test(e)?'"'+e.replace(r,function(e){var t=o[e];return"string"==typeof t?t:"\\u"+("0000"+e.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+e+'"'}function t(r,o){var s,c,u,p,h,f=i,l=o[r];switch(l&&"object"==typeof l&&"function"==typeof l.toJSON&&(l=l.toJSON(r)),"function"==typeof a&&(l=a.call(o,r,l)),typeof l){case"string":return e(l);case"number":return isFinite(l)?String(l):"null";case"boolean":case"null":return String(l);case"object":if(!l)return"null";if(i+=n,h=[],"[object Array]"===Object.prototype.toString.apply(l)){for(p=l.length,s=0;p>s;s+=1)h[s]=t(s,l)||"null";return u=0===h.length?"[]":i?"[\n"+i+h.join(",\n"+i)+"\n"+f+"]":"["+h.join(",")+"]",i=f,u}if(a&&"object"==typeof a)for(p=a.length,s=0;p>s;s+=1)c=a[s],"string"==typeof c&&(u=t(c,l),u&&h.push(e(c)+(i?": ":":")+u));else for(c in l)Object.prototype.hasOwnProperty.call(l,c)&&(u=t(c,l),u&&h.push(e(c)+(i?": ":":")+u));return u=0===h.length?"{}":i?"{\n"+i+h.join(",\n"+i)+"\n"+f+"}":"{"+h.join(",")+"}",i=f,u}}var r,i,n,o,a;return r=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,o={"\b":"\\b","	":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},"function"==typeof JSON.stringify?JSON.stringify:function(e,r,o){var s;if(i="",n="","number"==typeof o)for(s=0;o>s;s+=1)n+=" ";else"string"==typeof o&&(n=o);if(a=r,r&&"function"!=typeof r&&("object"!=typeof r||"number"!=typeof r.length))throw new Error("JSON.stringify");return t("",{"":e})}}(),s={inherits:t,trim:o,toLines:r,validateDate:i,isEmptyObject:n,jsonStringify:a};e.exports=s},function(e,t,r){"use strict";var i=r(7),n=r(8),o=r(9),a=r(10),s=r(11),c=r(12),u=r(13),p=r(14),h=r(15),f=r(16),l=r(17),d=r(18),y=r(19),U={handicap:function(e){return"undefined"!=typeof c[e]?c[e]:c["その他"]},csaHandicap:function(e){return"undefined"!=typeof i[e]?i[e]:i["その他"]},initialPlacement:function(e){return"undefined"!=typeof p[e]?p[e]:null},specialMove:function(e){return"undefined"!=typeof d[e]?d[e]:null},csaSpecialMove:function(e){return"undefined"!=typeof a[e]?a[e]:null},format:function(e){return"undefined"!=typeof s[e]?s[e]:null},piece:function(e){return"undefined"!=typeof f[e]?f[e]:null},promotedPiece:function(e){return"undefined"!=typeof l[e]?l[e]:null},csaPiece:function(e){return"undefined"!=typeof o[e]?o[e]:null},zenkakNumber:function(e){return"undefined"!=typeof y[e]?y[e]:null},kansuji:function(e){return"undefined"!=typeof h[e]?h[e]:null},header:function(e){return"undefined"!=typeof u[e]?u[e]:null},csaHeader:function(e){return"undefined"!=typeof n[e]?n[e]:null},pieceToPieceMapKey:function(e){for(var t in f)if(f[t]===e)return t;return null},pieceToCsaPieceMapKey:function(e){for(var t in o)if(o[t]===e)return t;return null}};e.exports=U},function(e,t,r){"use strict";function i(e){this.kifu={},this.header=e.header||{},this.body=e.body}var n=r(1),o=r(2);i.createMainObject=function(){return[{}]},i.createVariationsObject=function(){return[]},i.createHeaderObject=function(){return{}},i.prototype.getKifuObject=function(){return this.kifu},i.prototype.getKifuJSON=function(){return n.jsonStringify(this.kifu)},i.prototype.build=function(){this.kifu.header=this.buildHeader(),this.kifu.source=this.buildBody()},i.prototype.buildHeader=function(){return"undefined"==typeof this.header.handicap&&this.addHandicapToHeader(o.handicap("平手")),"undefined"==typeof this.header.moves&&this.addMovesToHeader(),"undefined"==typeof this.header.turn&&this.addTurnToHeader(),this.header},i.prototype.addTurnToHeader=function(){this.header.turn=!0},i.prototype.addHandicapToHeader=function(e){this.header.handicap=e},i.prototype.addMovesToHeader=function(){var e=this.body.main.length-1;"undefined"!=typeof this.body.main[e].special&&(e-=1),this.header.moves=e},i.prototype.addVariation=function(e,t){"undefined"!=typeof e.variations?e.variations.push(t):e.variations=[t]},i.prototype.getVariationMove=function(e,t){for(var r=e[e.length-1],i=t-r[0];0>=i;)e.pop(),r=e[e.length-1],i=t-r[0];return r[1][i]},i.prototype.buildBody=function(){var e=[],t=this.body.main,r=this.body.variations||null,i={};if(e.push([0,t]),null!==r)for(var n=0,o=r.length;o>n;n++)i=this.getVariationMove(e,r[n][0]),this.addVariation(i,r[n][1]),e.push([r[n][0],r[n][1]]);return t},e.exports=i},function(e,t,r){"use strict";function i(e,t){this.source=e,this.format=t,this.stack=[]}var n=r(1),o=r(2),a=r(3);i.prototype.parseHeaderUsed=function(e){return e.match(/(\d+)▲(\d+)△(\d+)$/)},i.prototype.parseHeaderBoard=function(e){var t=[];if("+---------------------------+"!==e[0]&&"+---------------------------+"!==e[9])return null;for(var r=1,i=0,n=0;9>=r;r++){if(i=0,n=e[r].length,"|"!==e[r].charAt(i))return null;i+=1,n-=2;for(var a="",s="";n>i;i+=2){if(a=e[r].charAt(i),s=e[r].charAt(i+1),"v"===a){if(null===o.piece(s))return null;s=0-o.piece(s)}else{if(" "!==a)return null;if("・"===s)s=0;else{if(null===o.piece(s))return null;s=o.piece(s)}}t.push(s)}if("|"!==e[r].charAt(i))return null;if(i+=1,r!==o.kansuji(e[r].charAt(i)))return null}return t},i.prototype.parseHeaderHand=function(e){for(var t={},r=0,i="",n=0,a=e.split(/[\s　]/),s=0,c=a.length;c>s;s++){if(r=o.piece(a[s].charAt(0)),i=o.pieceToCsaPieceMapKey(r),n=""===a[s].charAt(1)?1:o.kansuji(a[s].charAt(1)),null===r||null===n)return null;t[i]=n}return t},i.prototype.parseHeader=function(e){for(var t=a.createHeaderObject(),r="",i="",s=null,c=this.nextLine(n.toLines(e)),u=c();u;u=c()){if("９ ８ ７ ６ ５ ４ ３ ２ １"===u)r=o.header(u.charAt(0));else{if(s=u.match(/^(.+?)：(.+)$/),null===s)continue;r=o.header(n.trim(s[1])),i=n.trim(s[2])}switch(r){case"start":case"end":if(!n.validateDate(i))continue;"undefined"==typeof t.date&&(t.date={}),t.date[r]=i;continue;case"title":case"event":case"opening":case"site":t[r]=i;continue;case"limit":"undefined"==typeof t.time&&(t.time={}),t.time[r]=i;continue;case"handicap":t.handicap||(t[r]=o.handicap(i));continue;case"tactics_black":case"tactics_white":"undefined"==typeof t.tactics&&(t.tactics={}),t.tactics[r.split("_")[1]]=i;continue;case"player_black":case"player_white":"undefined"==typeof t.players&&(t.players={}),t.players[r.split("_")[1]]=i;continue;case"used":var p=this.parseHeaderUsed(i);if(null===p)continue;"undefined"==typeof t.time&&(t.time={}),t.moves=parseInt(p[1],10),t.time[r]={black:parseInt(p[2],10),white:parseInt(p[3],10)};continue;case"board":for(var h=[],f=0;10>=f;f++){if(u=c(),null===u||"+"!==u.charAt(0)&&"|"!==u.charAt(0))throw new Error("position figure is Invlid.");h.push(u)}if(h=this.parseHeaderBoard(h),null===h)throw new Error("position figure is Invlid.");t.board=h,t.handicap=o.handicap("その他");continue;case"hand_black":case"hand_white":var l=this.parseHeaderHand(i);if(null===l)throw new Error("hand piece is Invlid.");"undefined"==typeof t.hands&&(t.hands={}),t.hands[r.split("_")[1]]=l;continue;case"turn":t.turn=!1;continue;default:continue}}return n.isEmptyObject(t)?null:t},i.prototype.parseBodyComment=function(e,t){e.comment?e.comment+="\n"===t?t:"\n"+t:e.comment=t},i.prototype.parseBodyVariation=function(e){var t=[],r=null,i=0;if(r=this.stack[this.stack.length-1],i=e-r[0],i>0)this.stack.push([e,t]);else{do this.stack.pop(),r=this.stack[this.stack.length-1],i=e-r[0];while(0>=i);this.stack.push([e,t])}return t},i.prototype.parseBodySpecialMove=function(e){switch(e){case"先手の勝ち":case"後手の勝ち":case"上手の勝ち":case"下手の勝ち":return o.specialMove("投了");case"千日手":case"中断":case"持将棋":return o.specialMove(e);case"詰":return o.specialMove("詰み");case"先手の反則負け":case"後手の反則負け":case"上手の反則負け":case"下手の反則負け":return o.specialMove("反則負け")}return null},i.prototype.parseBodyFirstMove=function(e){for(var t=this.nextLine(n.toLines(e)),r=null,i=t(),o="";i;i=t()){switch(o=i.charAt(0)){case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":return r=this.parseMove(i);default:continue}break}return null},i.prototype.parseBodyFirstTurn=function(e){return null===e?!0:"undefined"==typeof e.turn?!0:e.turn},i.prototype.parseBody=function(e,t){var r=a.createMainObject(),i=a.createVariationsObject(),o="",s="",c=0,u=null,p=0,h=!0,f=null,l=null;this.stack.push([0,r]),l=r,u=this.parseBodyFirstMove(e),c=u.num,p=c%2,h=this.parseBodyFirstTurn(t);for(var d=this.nextLine(n.toLines(e)),y=d();y;y=d())switch(o=y.charAt(0),f=y.match(/^(.+?)：[\s　]*(\d+)[\s　]*手$/),null!==f&&(o=n.trim(f[1]),s=parseInt(f[2],10)),o){case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":var U=this.parseMove(y);if(c=this.checkMoves(c,U.num),this.storeMove(U),U.special){l.push({special:U.special});continue}l.push({move:{turn:this.takeTurn(p,h,U.num),to:U.to,from:U.from,piece:U.piece,time:U.time}});continue;case"*":var v="*"===y?"\n":y.slice(1);this.parseBodyComment(l[l.length-1],v);continue;case"変化":var F=[],P=null,k=0;if(s>c-1)throw new Error("moves of variation is invalid.");c=s,F=this.parseBodyVariation(s),i.push([s,F]),l=F,P=this.stack[this.stack.length-2],k=s-1-P[0],this.storeMove(P[1][k].move);continue;case"ま":var m="",K=y.match(/^まで\d{1,3}手で(.*)$/);null!==K&&"undefined"==typeof l[l.length-1].special&&(m=this.parseBodySpecialMove(K[1]),null!==m&&l.push({special:m}));continue;default:continue}if(1===r.length)throw new Error("This is invalid file.");return 0===i.length?{main:r}:{main:r,variations:i}},i.prototype.takeTurn=function(e,t,r){return e%2===r%2?t:!t},i.prototype.checkMoves=function(e,t){if(e!==t)throw new Error("moves is not in the order.");return e+1},i.prototype.storeMove=function(e){this.move=e},i.prototype.loadMove=function(){return this.move},i.prototype.parseMoveTo=function(e){var t=0,r=0;return"同"===e.charAt(0)?this.loadMove().to.concat():(t=o.zenkakNumber(e.charAt(0)),r=o.kansuji(e.charAt(1)),null!==t&&null!==r?[t,r]:null)},i.prototype.parseMoveFrom=function(e,t){var r=0,i=0;return"打"===e?[0,0]:"undefined"!=typeof t&&(r=parseInt(t.charAt(0),10),i=parseInt(t.charAt(1),10),r&&i)?[r,i]:null},i.prototype.parseMovePiece=function(e,t){return"成"===t?o.promotedPiece(e.slice(2)+"成"):o.piece(e.slice(2))},i.prototype.parseMoveTime=function(e){var t=e.match(/^(\d+):(\d+).*$/);return null!==t?60*parseInt(t[1],10)+parseInt(t[2],10):null},i.prototype.parseMoveLine=function(e){var t=new RegExp("^(\\d{1,3})\\s+((?:(?:同　|[１２３４５６７８９][一二三四五六七八九]成?)|[^同１２３４５６７８９])[^ (\\d)打成]+)(打|成)?(?:\\((\\d{2})\\))?(?:$|\\s*\\(\\s*([^ ]+)\\s*\\)$)");return e.match(t)},i.prototype.parseMove=function(e){var t=0,r=[],i=[],a=0,s=0,c=this.parseMoveLine(e);if(null===c)throw new Error("move is syntax error.");if(t=parseInt(c[1],10),null!==o.specialMove(c[2]))return{num:t,special:o.specialMove(c[2])};if(r=this.parseMoveTo(c[2]),a=this.parseMovePiece(c[2],c[3]),i=this.parseMoveFrom(c[3],c[4]),s="undefined"!=typeof s?this.parseMoveTime(n.trim(c[5])):0,null===r||null===i||null===a||null===s)throw new Error("move is syntax error.");return{num:t,to:r,from:i,piece:a,time:s}},i.prototype.nextLine=function(e){var t=-1;return function(){var r="";return t+=1,r=e[t],"undefined"==typeof r?null:("#"===r.charAt(0)&&(t+=1),e[t]?n.trim(e[t]):null)}},i.prototype.splitSource=function(e){return e.match(/^([\s\S]+?)\r?(?:\n|\r)手数----指手---------消費時間--\r?(?:\n|\r)([\s\S]+)$/)},i.prototype.parse=function(){var e=this.splitSource(this.source),t=null;return null===e?{header:null,body:this.parseBody(this.source,null)}:(t=this.parseHeader(e[1]),{header:t,body:this.parseBody(e[2],t)})},e.exports=i},function(e,t,r){"use strict";function i(e,t){this.source=e,this.format=t,this.stack=[]}var n=r(1),o=r(2),a=r(3),s=r(4),c=r(20);n.inherits(i,s),i.prototype.parseBodyTurn=function(e){return this.unityTurnMark(e.match(/(?:^|^[\s\S]+?(?:\r?(?:\n|\r)))([▲▼△▽])/)[1])},i.prototype.parseBody=function(e,t){var r=a.createMainObject(),i=a.createVariationsObject(),o="",s="",u=null,p="",h=null,f=null,l=null;this.stack.push([0,r]),h=r,p=this.parseBodyTurn(e),f=this.nextLine(this.bodyToLines(n.toLines(e))),l=new c(t,p);for(var d=f();d;d=f())switch(o=d.charAt(0),u=d.match(/^(.+?)：[\s　]*(\d+)[\s　]*手$/),null!==u&&(o=n.trim(u[1]),s=parseInt(u[2],10)),o){case"▲":case"▼":case"△":case"▽":var y=this.parseMove(d);p=this.turnCheck(p,y.turn),this.storeMove(y),y=l.complementMove(y),h.push({move:{turn:this.turnToBoolean(y.turn),to:y.to,from:y.from,piece:y.piece,time:0}});continue;case"*":var U="*"===d?"\n":d.slice(1);this.parseBodyComment(h[h.length-1],U);continue;case"変化":var v=[],F=null,P=0;if(l.checkVariationNumber(s)===!1)throw new Error("moves of variation is invalid.");v=this.parseBodyVariation(s),i.push([s,v]),h=v,F=this.stack[this.stack.length-2],P=s-1-F[0],this.storeMove(F[1][P].move),l.recessionBoard(s),p=l.getLastMoveTurn();continue;case"ま":var k="",m=d.match(/^まで\d{1,3}手で(.*)$/);null!==m&&"undefined"==typeof h[h.length-1].special&&(k=this.parseBodySpecialMove(m[1]),null!==k&&h.push({special:k}));continue;default:continue}if(1===r.length)throw new Error("This is invalid file.");return 0===i.length?{main:r}:{main:r,variations:i}},i.prototype.turnToBoolean=function(e){return"black"===e?!0:!1},i.prototype.turnCheck=function(e,t){if(e!==t)throw new Error("turn symbol is Invalid.");return"black"===e?"white":"black"},i.prototype.unityTurnMark=function(e){return/^[▲▼]$/.test(e)?"black":"white"},i.prototype.parseMoveMotion=function(e){return"行"===e||"入"===e?"上":"下"===e?"引":e},i.prototype.parseMovePiece=function(e){return o.piece(/^同(?!　)/.test(e)?e.slice(1):e.slice(2))},i.prototype.parseMoveLine=function(e){var t=new RegExp("^([▲▼△▽])((?:同|同　|[１２３４５６７８９][一二三四五六七八九])成?[^右左直上行入引下寄成不打\\s　]+)([右左直])?([上行入引下寄])?([成打]|不成)?$");return e.match(t)},i.prototype.parseMove=function(e){var t="",r=[],i=0,n="",o=this.parseMoveLine(e);if(null===o)throw new Error("move is syntax error.");if(t=this.unityTurnMark(o[1]),r=this.parseMoveTo(o[2]),i=this.parseMovePiece(o[2]),n=this.parseMoveMotion(o[4]),null===r||null===i)throw new Error("move is syntax error.");return{turn:t,to:r,piece:i,relative:o[3],motion:n,modifier:o[5]}},i.prototype.bodyToLines=function(e){for(var t=[],r="",i=function(e){return"/"+e},o=0,a=e.length;a>o;o++)if(r=n.trim(e[o]),/[▲▼△▽]/.test(r.charAt(0))!==!1){r=r.replace(/[▲▼△▽]/g,i),r=r.split("/");for(var s=0,c=r.length;c>s;s++)""!==r[s]&&t.push(r[s])}else t.push(r);return t},i.prototype.splitSource=function(e){return/^\r?(?:\n|\r)*[\s　]*[*▲▼△▽]/.test(e)?[void 0,void 0,e]:e.match(/^([\s\S]+?)\r?(?:\n|\r)[\s　]*([*▲▼△▽][\s\S]+?)$/)},i.prototype.parse=function(){var e=this.splitSource(this.source),t=null;if(null===e)throw new Error("This file is invalid.");return"undefined"==typeof e[1]?{header:t,body:this.parseBody(this.source,t)}:(t=this.parseHeader(e[1]),{header:t,body:this.parseBody(e[2],t)})},e.exports=i},function(e,t,r){"use strict";function i(e,t){this.source=e,this.format=t}var n=r(1),o=r(2),a=r(3);i.prototype.parseHeaderBoard=function(e){for(var t=[],r="",i="",n=0,a=0;9>n;n++)if(a=2,e[n].slice(0,a)==="P"+(n+1))for(var s=0;9>s;s++,a+=3){if(i=e[n].slice(a,a+3),r=i.charAt(0),"-"===r||"+"===r){if(i=o.csaPiece(i.slice(1)),null===i)return null;i="-"===r?0-i:i}else{if(" * "!==i&&" *"!==i)return null;i=0}t.push(i)}return t},i.prototype.parseHeaderHand=function(e){for(var t={},r=0,i="",n=0,a=2,s=(e.length-2)/4;s>n;n++,a+=4){if(r=o.csaPiece(e.slice(a+2,a+4)),i=o.pieceToCsaPieceMapKey(r),null===r)return null;t[i]="undefined"==typeof t[i]?1:t[i]+1}return t},i.prototype.parseHeader=function(e){for(var t=a.createHeaderObject(),r="",i="",s=null,c=this.nextLine(n.toLines(e)),u=c();u;u=c())if(s=u.match(/^((?:\+|\-)$|P|V|N(?:\+|\-)|\$)(.*)$/),null!==s)switch(r=s[1],i=n.trim(s[2]),r){case"+":case"-":t.turn="+"===r?!0:!1;continue;case"N+":case"N-":t.players||(t.players={}),t.players["N+"===r?"black":"white"]=i;continue;case"$":if(s=u.match(/^(.+?):(.*)$/),null===s)continue;switch(r=o.csaHeader(s[1]),i=n.trim(s[2]),r){case"start":case"end":if(!n.validateDate(i))continue;t.date||(t.date={}),t.date[r]=i;break;case"event":case"opening":case"site":t[r]=i;break;case"limit":t.time||(t.time={}),t.time[r]=i}continue;case"P":switch(i.charAt(0)){case"I":break;case"1":for(var p=u,h=[u],f=2;9>=f;){if(u=c(),null===u||"P"!==u.charAt(0))throw new Error("position figure is Invlid.");if(parseInt(u.charAt(1),10)!==f)throw new Error("position figure is Invlid.");p+=u,h.push(u),f+=1}if(t.handicap=o.csaHandicap(p),t.handicap===o.csaHandicap("その他")){if(t.handicap=o.csaHandicap("平手"),p=this.parseHeaderBoard(h),null===p)throw new Error("position figure is Invlid.");t.board=p}break;case"-":case"+":var l=this.parseHeaderHand(u);if(null===l)throw new Error("hand piece is Invlid.");"undefined"==typeof t.hands&&(t.hands={}),t.hands["+"===i.charAt(0)?"black":"white"]=l}continue;case"V":continue;default:continue}return n.isEmptyObject(t)?null:t},i.prototype.parseBodyComment=function(e,t){e.comment?e.comment+="\n"===t?t:"\n"+t:e.comment=t},i.prototype.parseBody=function(e){var t=a.createMainObject(),r="",i="",s=null;s=this.nextLine(this.eachSepComma(n.toLines(e))),i=s();for(var c=s();c;c=s())switch(r=c.charAt(0)){case"+":case"-":var u=this.parseMove(c);i=this.turnCheck(i,u.turn),t.push({move:{turn:this.turnToBoolean(u.turn),to:u.to,from:u.from,piece:u.piece,time:0}});continue;case"'":if("*"!==c.charAt(1))continue;var p="/'*"===c?"\n":c.slice(2);this.parseBodyComment(t[t.length-1],p);continue;case"T":var h=parseInt(c.slice(1),10);isNaN(h)===!1&&t[t.length-1].move&&(t[t.length-1].move.time=h);continue;case"%":null!==o.csaSpecialMove(c)&&t.push({special:c});continue;default:continue}if(1===t.length)throw new Error("This file is invalid.");return{main:t}},i.prototype.turnToBoolean=function(e){return"+"===e?!0:!1},i.prototype.turnCheck=function(e,t){if(e!==t)throw new Error("turn symbol is Invalid.");return"+"===e?"-":"+"},i.prototype.parseMovePiece=function(e){return o.csaPiece(e)},i.prototype.parseMoveLine=function(e){return e.match(/^([+-])(\d{2})(\d{2})([A-Z]{2})$/)},i.prototype.parseMove=function(e){var t="",r=[],i=[],n="",o=this.parseMoveLine(e);if(null===o)throw new Error("move is syntax error.");if(t=o[1],i=[parseInt(o[2].charAt(0),10),parseInt(o[2].charAt(1),10)],r=[parseInt(o[3].charAt(0),10),parseInt(o[3].charAt(1),10)],n=this.parseMovePiece(o[4]),null===n)throw new Error("move is syntax error.");return{turn:t,to:r,from:i,piece:n}},i.prototype.eachSepComma=function(e){for(var t=[],r="",i=0,o=e.length;o>i;i++)switch(r=n.trim(e[i]),r.charAt(0)){case"+":case"-":case"T":case"%":for(var a=r.split(/,/),s=0,c=a.length;c>s;s++)""!==a[s]&&t.push(a[s]);continue;default:t.push(e[i]);continue}return t},i.prototype.nextLine=function(e){var t=-1;return function(){var r="";return t+=1,r=e[t],"undefined"==typeof r?null:("'"===r.charAt(0)&&"*"!==r.charAt(1)&&(t+=1),e[t]?n.trim(e[t]):null)}},i.prototype.separatorSource=function(e){return e.split(/(?:\n|\r)\/\r?(?:\n|\r)/,1)[0]},i.prototype.splitSource=function(e){var t=new RegExp("(^(?:[\\s\\S]+?\\r?(?:\\n|\\r))?(?:\\+|\\-))\\r?(?:\\n|\\r)"),r=new RegExp("^(?:[\\s\\S]+?\\r?(?:\\n|\\r))?((?:\\+|\\-)\\r?(?:\\n|\\r)[\\s\\S]+)$"),i=e.match(t),n=e.match(r);return null!==i&&null!==n?[i[1],n[1]]:null},i.prototype.parse=function(){var e=this.separatorSource(this.source);if(e=this.splitSource(e),null===e)throw new Error("This file is invalid.");return{header:this.parseHeader(e[0]),body:this.parseBody(e[1])}},e.exports=i},function(e){"use strict";var t={};t["P1-KY-KE-GI-KI-OU-KI-GI-KE-KYP2 * -HI *  *  *  *  * -KA *P3-FU-FU-FU-FU-FU-FU-FU-FU-FUP4 *  *  *  *  *  *  *  *  *P5 *  *  *  *  *  *  *  *  *P6 *  *  *  *  *  *  *  *  *P7+FU+FU+FU+FU+FU+FU+FU+FU+FUP8 * +KA *  *  *  *  * +HI *P9+KY+KE+GI+KI+OU+KI+GI+KE+KY"]=0,t["P1-KY-KE-GI-KI-OU-KI-GI-KE *P2 * -HI *  *  *  *  * -KA *P3-FU-FU-FU-FU-FU-FU-FU-FU-FUP4 *  *  *  *  *  *  *  *  *P5 *  *  *  *  *  *  *  *  *P6 *  *  *  *  *  *  *  *  *P7+FU+FU+FU+FU+FU+FU+FU+FU+FUP8 * +KA *  *  *  *  * +HI *P9+KY+KE+GI+KI+OU+KI+GI+KE+KY"]=1,t["P1 * -KE-GI-KI-OU-KI-GI-KE-KYP2 * -HI *  *  *  *  * -KA *P3-FU-FU-FU-FU-FU-FU-FU-FU-FUP4 *  *  *  *  *  *  *  *  *P5 *  *  *  *  *  *  *  *  *P6 *  *  *  *  *  *  *  *  *P7+FU+FU+FU+FU+FU+FU+FU+FU+FUP8 * +KA *  *  *  *  * +HI *P9+KY+KE+GI+KI+OU+KI+GI+KE+KY"]=2,t["P1-KY-KE-GI-KI-OU-KI-GI-KE-KYP2 * -HI *  *  *  *  *  *  *P3-FU-FU-FU-FU-FU-FU-FU-FU-FUP4 *  *  *  *  *  *  *  *  *P5 *  *  *  *  *  *  *  *  *P6 *  *  *  *  *  *  *  *  *P7+FU+FU+FU+FU+FU+FU+FU+FU+FUP8 * +KA *  *  *  *  * +HI *P9+KY+KE+GI+KI+OU+KI+GI+KE+KY"]=3,t["P1-KY-KE-GI-KI-OU-KI-GI-KE-KYP2 *  *  *  *  *  *  * -KA *P3-FU-FU-FU-FU-FU-FU-FU-FU-FUP4 *  *  *  *  *  *  *  *  *P5 *  *  *  *  *  *  *  *  *P6 *  *  *  *  *  *  *  *  *P7+FU+FU+FU+FU+FU+FU+FU+FU+FUP8 * +KA *  *  *  *  * +HI *P9+KY+KE+GI+KI+OU+KI+GI+KE+KY"]=4,t["P1-KY-KE-GI-KI-OU-KI-GI-KE *P2 *  *  *  *  *  *  * -KA *P3-FU-FU-FU-FU-FU-FU-FU-FU-FUP4 *  *  *  *  *  *  *  *  *P5 *  *  *  *  *  *  *  *  *P6 *  *  *  *  *  *  *  *  *P7+FU+FU+FU+FU+FU+FU+FU+FU+FUP8 * +KA *  *  *  *  * +HI *P9+KY+KE+GI+KI+OU+KI+GI+KE+KY"]=5,t["P1-KY-KE-GI-KI-OU-KI-GI-KE-KYP2 *  *  *  *  *  *  *  *  *P3-FU-FU-FU-FU-FU-FU-FU-FU-FUP4 *  *  *  *  *  *  *  *  *P5 *  *  *  *  *  *  *  *  *P6 *  *  *  *  *  *  *  *  *P7+FU+FU+FU+FU+FU+FU+FU+FU+FUP8 * +KA *  *  *  *  * +HI *P9+KY+KE+GI+KI+OU+KI+GI+KE+KY"]=6,t["P1 * -KE-GI-KI-OU-KI-GI-KE *P2 *  *  *  *  *  *  *  *  *P3-FU-FU-FU-FU-FU-FU-FU-FU-FUP4 *  *  *  *  *  *  *  *  *P5 *  *  *  *  *  *  *  *  *P6 *  *  *  *  *  *  *  *  *P7+FU+FU+FU+FU+FU+FU+FU+FU+FUP8 * +KA *  *  *  *  * +HI *P9+KY+KE+GI+KI+OU+KI+GI+KE+KY"]=7,t["P1 *  * -GI-KI-OU-KI-GI-KE *P2 *  *  *  *  *  *  *  *  *P3-FU-FU-FU-FU-FU-FU-FU-FU-FUP4 *  *  *  *  *  *  *  *  *P5 *  *  *  *  *  *  *  *  *P6 *  *  *  *  *  *  *  *  *P7+FU+FU+FU+FU+FU+FU+FU+FU+FUP8 * +KA *  *  *  *  * +HI *P9+KY+KE+GI+KI+OU+KI+GI+KE+KY"]=8,t["P1 * -KE-GI-KI-OU-KI-GI *  *P2 *  *  *  *  *  *  *  *  *P3-FU-FU-FU-FU-FU-FU-FU-FU-FUP4 *  *  *  *  *  *  *  *  *P5 *  *  *  *  *  *  *  *  *P6 *  *  *  *  *  *  *  *  *P7+FU+FU+FU+FU+FU+FU+FU+FU+FUP8 * +KA *  *  *  *  * +HI *P9+KY+KE+GI+KI+OU+KI+GI+KE+KY"]=9,t["P1 *  * -GI-KI-OU-KI-GI *  *P2 *  *  *  *  *  *  *  *  *P3-FU-FU-FU-FU-FU-FU-FU-FU-FUP4 *  *  *  *  *  *  *  *  *P5 *  *  *  *  *  *  *  *  *P6 *  *  *  *  *  *  *  *  *P7+FU+FU+FU+FU+FU+FU+FU+FU+FUP8 * +KA *  *  *  *  * +HI *P9+KY+KE+GI+KI+OU+KI+GI+KE+KY"]=10,t["P1 *  *  * -KI-OU-KI *  *  *P2 *  *  *  *  *  *  *  *  *P3-FU-FU-FU-FU-FU-FU-FU-FU-FUP4 *  *  *  *  *  *  *  *  *P5 *  *  *  *  *  *  *  *  *P6 *  *  *  *  *  *  *  *  *P7+FU+FU+FU+FU+FU+FU+FU+FU+FUP8 * +KA *  *  *  *  * +HI *P9+KY+KE+GI+KI+OU+KI+GI+KE+KY"]=11,t["P1 *  *  *  * -OU *  *  *  *P2 *  *  *  *  *  *  *  *  *P3-FU-FU-FU-FU-FU-FU-FU-FU-FUP4 *  *  *  *  *  *  *  *  *P5 *  *  *  *  *  *  *  *  *P6 *  *  *  *  *  *  *  *  *P7+FU+FU+FU+FU+FU+FU+FU+FU+FUP8 * +KA *  *  *  *  * +HI *P9+KY+KE+GI+KI+OU+KI+GI+KE+KY"]=12,t["P1 *  *  *  * -OU *  *  *  *P2 *  *  *  *  *  *  *  *  *P3 *  *  *  *  *  *  *  *  *P4 *  *  *  *  *  *  *  *  *P5 *  *  *  *  *  *  *  *  *P6 *  *  *  *  *  *  *  *  *P7+FU+FU+FU+FU+FU+FU+FU+FU+FUP8 * +KA *  *  *  *  * +HI *P9+KY+KE+GI+KI+OU+KI+GI+KE+KY"]=13,t["その他"]=14,e.exports=t},function(e){"use strict";var t={$START_TIME:"start",$END_TIME:"end",$EVENT:"event",$OPENING:"opening",$TIME_LIMIT:"limit",$SITE:"site"};e.exports=t},function(e){"use strict";var t={FU:1,KY:2,KE:3,GI:4,KI:5,KA:6,HI:7,OU:8,TO:9,NY:10,NK:11,NG:12,UM:13,RY:14};e.exports=t},function(e){"use strict";var t={"%TORYO":"%TORYO","%TSUMI":"%TSUMI","%SENNICHITE":"%SENNICHITE","%CHUDAN":"%CHUDAN","%JISHOGI":"%JISHOGI","%ILLEGAL_MOVE":"%ILLEGAL_MOVE"};e.exports=t},function(e){"use strict";var t={kif:"Kif",Kif:"Kif",KIF:"Kif",ki2:"Ki2",Ki2:"Ki2",KI2:"Ki2",csa:"Csa",Csa:"Csa",CSA:"Csa",noformat:"noformat"};e.exports=t},function(e){"use strict";var t={"平手":0,"香落ち":1,"右香落ち":2,"角落ち":3,"飛車落ち":4,"飛香落ち":5,"二枚落ち":6,"四枚落ち":7,"五枚落ち":8,"左五枚落ち":9,"六枚落ち":10,"八枚落ち":11,"十枚落ち":12,"玉一枚":13,"その他":14};e.exports=t},function(e){"use strict";var t={"開始日時":"start","終了日時":"end","表題":"title","棋戦":"event","戦型":"opening","先手戦術":"tactics_black","後手戦術":"tactics_white","持ち時間":"limit","消費時間":"used","場所":"site","手合割":"handicap","先手":"player_black","下手":"player_black","後手":"player_white","上手":"player_white","９":"board","先手の持駒":"hand_black","下手の持駒":"hand_black","上手の持駒":"hand_white","後手の持駒":"hand_white","後手番":"turn"};e.exports=t},function(e){"use strict";var t=[[-2,-3,-4,-5,-8,-5,-4,-3,-2,0,-7,0,0,0,0,0,-6,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,0,6,0,0,0,0,0,7,0,2,3,4,5,8,5,4,3,2],[-2,-3,-4,-5,-8,-5,-4,-3,0,0,-7,0,0,0,0,0,-6,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,0,6,0,0,0,0,0,7,0,2,3,4,5,8,5,4,3,2],[0,-3,-4,-5,-8,-5,-4,-3,-2,0,-7,0,0,0,0,0,-6,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,0,6,0,0,0,0,0,7,0,2,3,4,5,8,5,4,3,2],[-2,-3,-4,-5,-8,-5,-4,-3,-2,0,-7,0,0,0,0,0,0,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,0,6,0,0,0,0,0,7,0,2,3,4,5,8,5,4,3,2],[-2,-3,-4,-5,-8,-5,-4,-3,-2,0,0,0,0,0,0,0,-6,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,0,6,0,0,0,0,0,7,0,2,3,4,5,8,5,4,3,2],[-2,-3,-4,-5,-8,-5,-4,-3,0,0,0,0,0,0,0,0,-6,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,0,6,0,0,0,0,0,7,0,2,3,4,5,8,5,4,3,2],[-2,-3,-4,-5,-8,-5,-4,-3,-2,0,0,0,0,0,0,0,0,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,0,6,0,0,0,0,0,7,0,2,3,4,5,8,5,4,3,2],[0,-3,-4,-5,-8,-5,-4,-3,0,0,0,0,0,0,0,0,0,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,0,6,0,0,0,0,0,7,0,2,3,4,5,8,5,4,3,2],[0,0,-4,-5,-8,-5,-4,-3,0,0,0,0,0,0,0,0,0,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,0,6,0,0,0,0,0,7,0,2,3,4,5,8,5,4,3,2],[0,-3,-4,-5,-8,-5,-4,0,0,0,0,0,0,0,0,0,0,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,0,6,0,0,0,0,0,7,0,2,3,4,5,8,5,4,3,2],[0,0,-4,-5,-8,-5,-4,0,0,0,0,0,0,0,0,0,0,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,0,6,0,0,0,0,0,7,0,2,3,4,5,8,5,4,3,2],[0,0,0,-5,-8,-5,0,0,0,0,0,0,0,0,0,0,0,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,0,6,0,0,0,0,0,7,0,2,3,4,5,8,5,4,3,2],[0,0,0,0,-8,0,0,0,0,0,0,0,0,0,0,0,0,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,0,6,0,0,0,0,0,7,0,2,3,4,5,8,5,4,3,2],[0,0,0,0,-8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,0,6,0,0,0,0,0,7,0,2,3,4,5,8,5,4,3,2]];e.exports=t},function(e){"use strict";var t={"一":1,"二":2,"三":3,"四":4,"五":5,"六":6,"七":7,"八":8,"九":9,"十":10};e.exports=t},function(e){"use strict";var t={"歩":1,"香":2,"桂":3,"銀":4,"金":5,"角":6,"飛":7,"王":8,"玉":8,"と":9,"成香":10,"杏":10,"成桂":11,"圭":11,"成銀":12,"全":12,"馬":13,"龍":14};e.exports=t},function(e){"use strict";var t={"歩成":9,"香成":10,"桂成":11,"銀成":12,"角成":13,"飛成":14};e.exports=t},function(e){"use strict";var t={"投了":"%TORYO","詰み":"%TSUMI","千日手":"%SENNICHITE","中断":"%CHUDAN","持将棋":"%JISHOGI","反則負け":"%ILLEGAL_MOVE"};e.exports=t},function(e){"use strict";var t={"１":1,"２":2,"３":3,"４":4,"５":5,"６":6,"７":7,"８":8,"９":9};e.exports=t},function(e,t,r){"use strict";function i(e,t){this.initialize.call(this,e,t)}var n=r(2),o=r(21);i.prototype.initialize=function(e,t){var r=0,i=[];if(null===e)return void(this.board=new o(this.getInitPlacement(n.handicap("平手")),t));if(r="undefined"==typeof e.handicap?n.handicap("平手"):e.handicap,r===n.handicap("その他")&&"undefined"==typeof e.board)throw new Error("Check the board and handicap in kifu.");i="undefined"!=typeof e.board?e.board:this.getInitPlacement(r),this.board=new o(i,t,e.hands)},i.prototype.complementMove=function(e){var t=this.advanceBoard(e);return e.from=t.from,"成"===e.modifier&&(e.piece=t.piece.getPiece()),e},i.prototype.advanceBoard=function(e){var t=[],r=null,i=null;if(r=this.board.findPiece(e),null===r)throw new Error("Have specified a piece that can not be used.");return this.board.setTurn(e.turn),this.board.saveMoveRecord(r,e),i=this.board.capturePiece(e.to[0],e.to[1]),t=[r.getFile(),r.getRank()],this.board.movePiece(r,e.to[0],e.to[1]),"成"===e.modifier&&this.board.promotePiece(r),{from:t,piece:r}},i.prototype.recessionBoard=function(e){this.board.restoreMoveRecord(e)},i.prototype.getLastMoveTurn=function(){return this.board.getTurn()},i.prototype.checkVariationNumber=function(e){var t=this.board.getRecord();return e<=t.length?!0:!1},i.prototype.getInitPlacement=function(e){var t=n.initialPlacement(e);return null===t?n.initialPlacement(n.handicap("平手")):t},e.exports=i},function(e,t,r){"use strict";function i(e,t,r){this.initialize.call(this,e,t,r)}var n=r(2),o=r(22),a=r(23);i.prototype.initialize=function(e,t,r){this.boardPieces=new o(n.piece("龍")),this.handPieces=new o(n.piece("飛")),this.turn=t,this.board=this.initializeBoard(e),"undefined"!=typeof r&&this.initializeHand(r),this.record=[]},i.prototype.initializeHand=function(e){for(var t in e)for(var r in e[t])for(var i=0,o=e[t][r];o>i;i++)this.handPieces.add(new a(n.csaPiece(r),t,0,0))},i.prototype.initializeBoard=function(e){for(var t=null,r=0,i=[],n=1;9>=n;n++)i[n]=[];for(n=1;9>=n;n++)for(var o=9;o>=1;o--)t=0<e[r]?new a(e[r],"black",o,n):0>e[r]?new a(-1*e[r],"white",o,n):null,null!==t&&this.boardPieces.add(t),i[o][n]=t,r+=1;return i},i.prototype.setTurn=function(e){this.turn=e},i.prototype.getTurn=function(){return this.turn},i.prototype.getRecord=function(){return this.record},i.prototype.findPiece=function(e){var t=0,r=0,i=null,n=[];if("打"!==e.modifier)for(n=this.boardPieces.getPieces(e.piece),t=0,r=this.boardPieces.getPiecesCount(e.piece);r>t;t++)if(i=n[t],i.getPlayer()===e.turn&&i.matchMovement(e)&&!this.checkPowerOfMove(i,e))return i;for(n=this.handPieces.getPieces(e.piece),t=0,r=this.handPieces.getPiecesCount(e.piece);r>t;t++)if(i=n[t],i.getPlayer()===e.turn&&!this.checkPowerOfMove(i,e))return this.handPieces.remove(i,t),this.boardPieces.add(i),i;return null},i.prototype.capturePiece=function(e,t){var r=this.board[e][t];return null===r?null:(this.boardPieces.remove(r),r.captured(),this.handPieces.add(r),r)},i.prototype.promotePiece=function(e){this.boardPieces.remove(e),e.promote(),this.boardPieces.add(e)
},i.prototype.movePiece=function(e,t,r){0!==e.getFile()&&0!==e.getRank()&&(this.board[e.getFile()][e.getRank()]=null),this.board[t][r]=e,e.update({file:t,rank:r})},i.prototype.checkPowerOfMove=function(e,t){var r=e.getFile()-t.to[0],i=e.getRank()-t.to[1],o=this.board[t.to[0]][t.to[1]];if(null!==o&&o.getPlayer()===t.turn)return!0;if(e.getPiece()===n.piece("桂"))return!1;if(0===e.getFile()&&0===e.getRank())return null!==o?!0:!1;r>0?r=-1:0>r&&(r=1),i>0?i=-1:0>i&&(i=1);for(var a=1;e.getFile()+a*r!==t.to[0]||e.getRank()+a*i!==t.to[1];a++)if(null!==this.board[e.getFile()+a*r][e.getRank()+a*i])return!0;return!1},i.prototype.saveMoveRecord=function(e,t){var r={},i=this.board[t.to[0]][t.to[1]];r.turn=t.turn,r.movedPieceData={pieceObject:e,originPiece:e.getPiece(),originPosition:[e.getFile(),e.getRank()],modifier:t.modifier},null!==i&&(r.capturedPieceData={pieceObject:i,originPiece:i.getPiece(),originPosition:[i.getFile(),i.getRank()],player:i.getPlayer()}),this.record.push(r)},i.prototype.restoreDropPiece=function(e){this.board[e.pieceObject.getFile()][e.pieceObject.getRank()]=null,this.boardPieces.remove(e.pieceObject),this.handPieces.add(e.pieceObject),e.pieceObject.update({file:0,rank:0})},i.prototype.restoreMovedPiece=function(e){this.board[e.pieceObject.getFile()][e.pieceObject.getRank()]=null,this.board[e.originPosition[0]][e.originPosition[1]]=e.pieceObject,"成"===e.modifier&&this.boardPieces.remove(e.pieceObject),e.pieceObject.update({piece:e.originPiece,file:e.originPosition[0],rank:e.originPosition[1]}),"成"===e.modifier&&this.boardPieces.add(e.pieceObject)},i.prototype.restoreCapturedPiece=function(e){this.board[e.originPosition[0]][e.originPosition[1]]=e.pieceObject,this.handPieces.remove(e.pieceObject),e.pieceObject.update({piece:e.originPiece,player:e.player,file:e.originPosition[0],rank:e.originPosition[1]}),this.boardPieces.add(e.pieceObject)},i.prototype.restoreMoveRecord=function(e){var t=null;e-=1;for(var r=this.record.length-1;r>=e;r--)t=this.record.pop(),this.turn=t.turn,0!==t.movedPieceData.originPosition[0]||0!==t.movedPieceData.originPosition[1]?(this.restoreMovedPiece(t.movedPieceData),"undefined"!=typeof t.capturedPieceData&&this.restoreCapturedPiece(t.capturedPieceData)):this.restoreDropPiece(t.movedPieceData)},e.exports=i},function(e){"use strict";function t(e){this.initialize.call(this,e)}t.prototype.initialize=function(e){this.list=[];for(var t=0;e>=t;t++)this.list[t]=[]},t.prototype.add=function(e){this.list[e.getPiece()].push(e)},t.prototype.remove=function(e,t){if("undefined"==typeof t&&(t=this.getPieceIndex(e),-1===t))throw new Error("[PieceList.prototype.remove] Internal error.");this.list[e.getPiece()].splice(t,1)},t.prototype.getPieces=function(e){return this.list[e]},t.prototype.getPiecesCount=function(e){return this.list[e].length},t.prototype.getPieceIndex=function(e){for(var t=this.getPieces(e.getPiece()),r=0,i=this.getPiecesCount(e.getPiece());i>r;r++)if(e===t[r])return r;return-1},e.exports=t},function(e,t,r){"use strict";function i(e,t,r,i){this.piece=e,this.player=t,this.file=r,this.rank=i}var n=r(2);i.prototype.getPiece=function(){return this.piece},i.prototype.getFile=function(){return this.file},i.prototype.getRank=function(){return this.rank},i.prototype.getPlayer=function(){return this.player},i.prototype.update=function(e){"undefined"!=typeof e.piece&&(this.piece=e.piece),"undefined"!=typeof e.player&&(this.player=e.player),"undefined"!=typeof e.file&&(this.file=e.file),"undefined"!=typeof e.rank&&(this.rank=e.rank)},i.prototype.promote=function(){this.piece=n.promotedPiece(n.pieceToPieceMapKey(this.piece)+"成")},i.prototype.demote=function(){switch(this.piece){case n.piece("と"):this.piece=n.piece("歩");break;case n.piece("成香"):this.piece=n.piece("香");break;case n.piece("成桂"):this.piece=n.piece("桂");break;case n.piece("成銀"):this.piece=n.piece("銀");break;case n.piece("馬"):this.piece=n.piece("角");break;case n.piece("龍"):this.piece=n.piece("飛")}},i.prototype.captured=function(){this.player="black"===this.player?"white":"black",this.file=0,this.rank=0,this.demote()},i.prototype.matchMovement=function(e){return this["case"+n.pieceToCsaPieceMapKey(e.piece)](e)},i.prototype.checkRelative=function(e,t){var r=0;switch((e.piece===n.piece("馬")||e.piece===n.piece("龍"))&&(r="右"===e.relative&&"white"===this.player||"左"===e.relative&&"black"===this.player?-1:1),e.relative){case"右":if("black"===this.player){if(t>=r)return!1}else if(r>=t)return!1;break;case"左":if("black"===this.player){if(r>=t)return!1}else if(t>=r)return!1;break;case"直":if(0!==t)return!1}return!0},i.prototype.checkMotion=function(e,t){switch(e.motion){case"上":if("black"===this.player){if(0>=t)return!1}else if(t>=0)return!1;break;case"引":if("black"===this.player){if(t>=0)return!1}else if(0>=t)return!1;break;case"寄":if(0!==t)return!1}return!0},i.prototype.checkDestForward=function(e,t){var r="black"===this.player?-1:1;return this.file===e&&this.rank+r===t?!0:!1},i.prototype.checkDestBackward=function(e,t){var r="black"===this.player?1:-1;return this.file===e&&this.rank+r===t?!0:!1},i.prototype.checkDestUpperLeft=function(e,t){var r="black"===this.player?1:-1,i="black"===this.player?-1:1;return this.file+r===e&&this.rank+i===t?!0:!1},i.prototype.checkDestLeft=function(e,t){var r="black"===this.player?1:-1;return this.file+r===e&&this.rank===t?!0:!1},i.prototype.checkDestBottomLeft=function(e,t){var r="black"===this.player?1:-1,i="black"===this.player?1:-1;return this.file+r===e&&this.rank+i===t?!0:!1},i.prototype.checkDestUpperRight=function(e,t){var r="black"===this.player?-1:1,i="black"===this.player?-1:1;return this.file+r===e&&this.rank+i===t?!0:!1},i.prototype.checkDestRight=function(e,t){var r="black"===this.player?-1:1;return this.file+r===e&&this.rank===t?!0:!1},i.prototype.checkDestBottomRight=function(e,t){var r="black"===this.player?-1:1,i="black"===this.player?1:-1;return this.file+r===e&&this.rank+i===t?!0:!1},i.prototype.checkDestDirectly=function(e,t){for(var r="black"===this.player?this.rank:10-this.rank,i=1;--r;i++)if(this.file===e&&this.rank+("black"===this.player?-i:i)===t)return!0;return!1},i.prototype.checkDestDiagonal=function(e,t){var r=0,i=0;for(r=this.file+1,i=this.rank-1;9>=r&&i>=1;r++,i--)if(r===e&&i===t)return!0;for(r=this.file+1,i=this.rank+1;9>=r&&9>=i;r++,i++)if(r===e&&i===t)return!0;for(r=this.file-1,i=this.rank-1;r>=1&&i>=1;r--,i--)if(r===e&&i===t)return!0;for(r=this.file-1,i=this.rank+1;r>=1&&9>=i;r--,i++)if(r===e&&i===t)return!0;return!1},i.prototype.checkDestOrthogonal=function(e,t){var r=0,i=0;for(r=this.file+1;9>=r;r++)if(r===e&&this.rank===t)return!0;for(i=this.rank-1;i>=1;i--)if(this.file===e&&i===t)return!0;for(r=this.file-1;r>=1;r--)if(r===e&&this.rank===t)return!0;for(i=this.rank+1;9>=i;i++)if(this.file===e&&i===t)return!0;return!1},i.prototype.caseFU=function(e){return this.checkDestForward(e.to[0],e.to[1])?!0:!1},i.prototype.caseKY=function(e){return this.checkDestDirectly(e.to[0],e.to[1])?!0:!1},i.prototype.caseKE=function(e){var t=this.file-e.to[0];return this.checkRelative(e,t)?1!==t&&-1!==t?!1:this.rank+("black"===this.player?-2:2)===e.to[1]?!0:!1:!1},i.prototype.caseGI=function(e){var t=this.file-e.to[0],r=this.rank-e.to[1];return this.checkRelative(e,t)&&this.checkMotion(e,r)?this.checkDestUpperLeft(e.to[0],e.to[1])?!0:this.checkDestBottomLeft(e.to[0],e.to[1])?!0:this.checkDestUpperRight(e.to[0],e.to[1])?!0:this.checkDestBottomRight(e.to[0],e.to[1])?!0:this.checkDestForward(e.to[0],e.to[1])?!0:!1:!1},i.prototype.caseKI=function(e){var t=this.file-e.to[0],r=this.rank-e.to[1];return this.checkRelative(e,t)&&this.checkMotion(e,r)?this.checkDestUpperLeft(e.to[0],e.to[1])?!0:this.checkDestLeft(e.to[0],e.to[1])?!0:this.checkDestUpperRight(e.to[0],e.to[1])?!0:this.checkDestRight(e.to[0],e.to[1])?!0:this.checkDestForward(e.to[0],e.to[1])?!0:this.checkDestBackward(e.to[0],e.to[1])?!0:!1:!1},i.prototype.caseKA=function(e){var t=this.file-e.to[0],r=this.rank-e.to[1];return this.checkRelative(e,t)&&this.checkMotion(e,r)&&this.checkDestDiagonal(e.to[0],e.to[1])?!0:!1},i.prototype.caseHI=function(e){var t=this.file-e.to[0],r=this.rank-e.to[1];return this.checkRelative(e,t)&&this.checkMotion(e,r)&&this.checkDestOrthogonal(e.to[0],e.to[1])?!0:!1},i.prototype.caseOU=function(e){return this.checkDestUpperLeft(e.to[0],e.to[1])?!0:this.checkDestLeft(e.to[0],e.to[1])?!0:this.checkDestBottomLeft(e.to[0],e.to[1])?!0:this.checkDestUpperRight(e.to[0],e.to[1])?!0:this.checkDestRight(e.to[0],e.to[1])?!0:this.checkDestBottomRight(e.to[0],e.to[1])?!0:this.checkDestForward(e.to[0],e.to[1])?!0:this.checkDestBackward(e.to[0],e.to[1])?!0:!1},i.prototype.caseTO=function(e){return this.caseKI(e)},i.prototype.caseNY=function(e){return this.caseKI(e)},i.prototype.caseNK=function(e){return this.caseKI(e)},i.prototype.caseNG=function(e){return this.caseKI(e)},i.prototype.caseUM=function(e){var t=this.file-e.to[0],r=this.rank-e.to[1];return this.checkRelative(e,t)&&this.checkMotion(e,r)?this.checkDestUpperLeft(e.to[0],e.to[1])?!0:this.checkDestLeft(e.to[0],e.to[1])?!0:this.checkDestBottomLeft(e.to[0],e.to[1])?!0:this.checkDestUpperRight(e.to[0],e.to[1])?!0:this.checkDestRight(e.to[0],e.to[1])?!0:this.checkDestBottomRight(e.to[0],e.to[1])?!0:this.checkDestForward(e.to[0],e.to[1])?!0:this.checkDestBackward(e.to[0],e.to[1])?!0:this.checkDestDiagonal(e.to[0],e.to[1])?!0:!1:!1},i.prototype.caseRY=function(e){var t=this.file-e.to[0],r=this.rank-e.to[1];return this.checkRelative(e,t)&&this.checkMotion(e,r)?this.checkDestUpperLeft(e.to[0],e.to[1])?!0:this.checkDestLeft(e.to[0],e.to[1])?!0:this.checkDestBottomLeft(e.to[0],e.to[1])?!0:this.checkDestUpperRight(e.to[0],e.to[1])?!0:this.checkDestRight(e.to[0],e.to[1])?!0:this.checkDestBottomRight(e.to[0],e.to[1])?!0:this.checkDestForward(e.to[0],e.to[1])?!0:this.checkDestBackward(e.to[0],e.to[1])?!0:this.checkDestOrthogonal(e.to[0],e.to[1])?!0:!1:!1},e.exports=i}]);